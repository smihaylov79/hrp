{% extends "base.html" %}

{% load custom_filters_cooking %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">–†–µ—Ü–µ–ø—Ç–∏</h2>

    {% if user.is_authenticated %}
<a href="{% url 'create_recipe' %}" class="btn btn-success mb-3">–î–æ–±–∞–≤–∏ —Ä–µ—Ü–µ–ø—Ç–∞</a>
{% else %}
<a href="{% url 'login' %}" class="btn btn-primary mb-3">–í–ª–µ–∑ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏ –∑–∞ –ø–æ–≤–µ—á–µ –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
{% endif %}
<div class="btn-group mb-4" role="group" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏">
    <button type="button" class="btn btn-outline-secondary category-btn" data-category="all">–í—Å–∏—á–∫–∏</button>
    {% for category in categories %}
        <button type="button" class="btn btn-outline-secondary category-btn" data-category="{{ category.name }}">{{ category.name }}</button>
    {% endfor %}
</div>

<div class="flex-grow-1">
    <label for="recipe-search" class="form-label">üîç –¢—ä—Ä—Å–∏ —Ä–µ—Ü–µ–ø—Ç–∞:</label>
    <input type="text" id="recipe-search" class="form-control" placeholder="–ò–º–µ..." onkeyup="filterRecipeByName()">
  </div>

<form method="get" action="{% url 'recipe_list' %}" class="mb-4">
  <label for="ingredient-select" class="form-label">üßÇ –†–µ—Ü–µ–ø—Ç–∞ —Å –ø—Ä–æ–¥—É–∫—Ç:</label>
  <select id="ingredient-select" name="ingredient" class="form-select" onchange="this.form.submit()">
    <option value="all" {% if request.GET.ingredient == "all" %}selected{% endif %}>-- –í—Å–∏—á–∫–∏ --</option>
    {% for product in user_inventory %}
      <option value="{{ product }}"
          {% if request.GET.ingredient == product|stringformat:"s" %}selected{% endif %}>
    {{ product|get_product_name }}
    {% endfor %}
  </select>
  <input type="hidden" name="category" value="{{ selected_category }}">
</form>

<div class="row">
    {% for recipe in recipes %}
        <div class="card h-100 border-light shadow-sm recipe-card"
                data-category="{{ recipe.category.name|lower }}"
                data-name="{{ recipe.name|lower }}"
                {% if recipe.is_top %}class="top-recipe"{% endif %}>
  <div class="row g-0 align-items-center">
    <div class="col-md-4 d-flex align-items-center" style="height: 180px;">
  {% if recipe.image %}
    <img src="{{ recipe.image.url }}" class="img-fluid mh-100 w-100 object-fit-cover rounded-start" alt="{{ recipe.name }}">
  {% else %}
    <img src="/media/recipe_images/no_image.png" class="img-fluid mh-100 w-100 object-fit-cover rounded-start" alt="Default Image">
  {% endif %}
</div>

    <div class="col-md-5">
      <div class="card-body">
        <h5 class="card-title"><a href="{% url 'recipe_view' recipe.id %}">{{ recipe.name }}</a></h5>
        <p class="card-text mb-1"><strong>‚è±Ô∏è:</strong> {{ recipe.time_to_prepare }} –º–∏–Ω</p>
        <p class="card-text mb-1"><strong>üí∞:</strong> {% if user.is_authenticated %}{{ recipe.user_cost }} –ª–≤.{% else %}N/A{% endif %}</p>
        <p class="card-text mb-1"><strong>üî•:</strong> {{ recipe.calculate_calories }} kcal</p>
        <p class="card-text mb-1"><strong>üìÇ:</strong> {{ recipe.category.name }}</p>

        {% if recipe.user_availability_status == "OK" %}
          <p class="text-success small">‚úÖ –í—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –Ω–∞–ª–∏—á–Ω–∏</p>
        {% else %}
          <p class="text-danger small">‚ùå –õ–∏–ø—Å–≤–∞—â–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</p>
        {% endif %}

        {% if recipe.times_cooked %}
          <p class="text-muted small mt-2">üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–≤—è–Ω–∞ <strong>{{ recipe.times_cooked }}</strong> –ø—ä—Ç–∏</p>
        {% endif %}
      </div>
    </div>

    <div class="col-md-3 text-center px-3">
      {% if not recipe.user_availability %}
        <form action="{% url 'generate_recipe_shopping_list' recipe.id %}" method="POST" class="mb-2">
          {% csrf_token %}
          <button type="submit" class="btn btn-warning btn-sm w-100">üõí –°–ø–∏—Å—ä–∫</button>
        </form>
      {% endif %}

      {% if user.is_authenticated %}
        <form action="{% url 'cook_recipe' recipe.id %}" method="POST">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-sm w-100">üç≥ –ü—Ä–∏–≥–æ—Ç–≤–∏</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

        <script>
  let selectedCategory = "all";

  function filterRecipes() {
    const searchInput = document.getElementById("recipe-search").value.toLowerCase();
    const cards = document.querySelectorAll(".recipe-card");

    cards.forEach(card => {
      const cardCategory = card.dataset.category || "";
      const cardName = card.dataset.name || "";
      const isTop = card.classList.contains("top-recipe");

      const categoryMatch = selectedCategory === "all" || cardCategory === selectedCategory;
      const nameMatch = cardName.includes(searchInput);

      const showCard = searchInput ? nameMatch : categoryMatch;
      card.style.display = showCard ? "block" : "none";
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("recipe-search").addEventListener("input", filterRecipes);

    document.querySelectorAll(".category-btn").forEach(button => {
      button.addEventListener("click", () => {
        document.querySelectorAll(".category-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        selectedCategory = button.dataset.category.toLowerCase();
        filterRecipes();
      });
    });

    filterRecipes(); // initial call
  });
</script>

{#    <div class="col-md-6 col-lg-4 mb-4 recipe-card {% if recipe.is_top %}top-recipe{% endif %}"#}
{#                    data-category="{{ recipe.category.name|lower }}"#}
{#                    data-name="{{ recipe.name|lower }}">#}
{#        <div class="card h-100">#}
{#            {% if recipe.image %}#}
{#                <img src="{{ recipe.image.url }}" class="card-img-top" alt="{{ recipe.name }}">#}
{#            {% else %}#}
{#                <img src="/media/recipe_images/no_image.png" class="card-img-top" alt="Default Image">#}
{#            {% endif %}#}
{#            <div class="card-body">#}
{#                <h5 class="card-title"><a href="{% url 'recipe_view' recipe.id %}">{{ recipe.name }}</a></h5>#}
{#                <p class="card-text"><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ recipe.category.name }}</p>#}
{#                <p class="card-text"><strong>–í—Ä–µ–º–µ –∑–∞ –ø—Ä–∏–≥–æ—Ç–≤—è–Ω–µ:</strong> {{ recipe.time_to_prepare }} –º–∏–Ω</p>#}
{#                <p class="card-text"><strong>–¶–µ–Ω–∞:</strong> {% if user.is_authenticated %}{{ recipe.user_cost }} –ª–≤.{% else %}N/A{% endif %}</p>#}
{#                <p class="card-text"><strong>–ö–∞–ª–æ—Ä–∏–∏:</strong> {{ recipe.calculate_calories }} kcal</p>#}
{#                {% if recipe.user_availability_status == "OK" %}#}
{#                    <p class="text-success">‚úÖ –í—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –Ω–∞–ª–∏—á–Ω–∏</p>#}
{#                {% else %}#}
{#                    <p class="text-danger">‚ùå –õ–∏–ø—Å–≤–∞—â–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</p>#}
{#                {% endif %}#}
{##}
{#                {% if not recipe.user_availability %}#}
{#                <form action="{% url 'generate_recipe_shopping_list' recipe.id %}" method="POST">#}
{#                    {% csrf_token %}#}
{#                    <button type="submit" class="btn btn-warning btn-sm mt-2">üõí –ì–µ–Ω–µ—Ä–∏—Ä–∞–π —Å–ø–∏—Å—ä–∫</button>#}
{#                </form>#}
{#                {% endif %}#}
{#                {% if user.is_authenticated %}#}
{#<div class="d-flex justify-content-between align-items-center px-3 pb-3">#}
{#    <form action="{% url 'cook_recipe' recipe.id %}" method="POST" class="mb-0">#}
{#        {% csrf_token %}#}
{#        <button type="submit" class="btn btn-success btn-sm">üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–≤–∏</button>#}
{#    </form>#}
{#    <span class="text-muted small">–ü—Ä–∏–≥–æ—Ç–≤—è–Ω–∞ <strong>{{ recipe.times_cooked }}</strong> –ø—ä—Ç–∏</span>#}
{#</div>#}
{#{% endif %}#}
{##}
{#            </div>#}
{#        </div>#}
{#    </div>#}
    {% endfor %}
</div>

</div>

{#    <script>#}
{#    let selectedCategory = "all";#}
{##}
{#    function filterRecipes() {#}
{#        const searchInput = document.getElementById("recipe-search").value.toLowerCase();#}
{#        const cards = document.querySelectorAll(".recipe-card");#}
{##}
{#        cards.forEach(card => {#}
{#            const cardCategory = card.dataset.category;#}
{#            const cardName = card.dataset.name;#}
{#            const isTop = card.classList.contains("top-recipe");#}
{##}
{#            const categoryMatch = (selectedCategory === "all" && isTop) || cardCategory === selectedCategory;#}
{#            const nameMatch = cardName.includes(searchInput);#}
{##}
{#            const showCard = searchInput ? nameMatch : categoryMatch;#}
{#            card.style.display = showCard ? "block" : "none";#}
{#        });#}
{#    }#}
{##}
{#    // Search filter#}
{#    document.getElementById("recipe-search").addEventListener("input", filterRecipes);#}
{##}
{#    // Category filter#}
{#    document.querySelectorAll("[data-category]").forEach(btn => {#}
{#        btn.addEventListener("click", () => {#}
{#            selectedCategory = btn.getAttribute("data-category").toLowerCase();#}
{#            filterRecipes();#}
{#        });#}
{#    });#}
{##}
{#    document.addEventListener("DOMContentLoaded", () => {#}
{#        filterRecipes();#}
{#    });#}
{#</script>#}
{##}
{#    <script>#}
{#    document.querySelectorAll(".category-btn").forEach(button => {#}
{#        button.addEventListener("click", () => {#}
{#            // Remove "active" from all buttons#}
{#            document.querySelectorAll(".category-btn").forEach(btn => {#}
{#                btn.classList.remove("active");#}
{#            });#}
{##}
{#            // Add "active" to the clicked one#}
{#            button.classList.add("active");#}
{##}
{#            // Trigger your category filtering logic#}
{#            selectedCategory = button.getAttribute("data-category").toLowerCase();#}
{#            filterRecipes();#}
{#        });#}
{#    });#}
{#</script>#}



{% endblock %}

