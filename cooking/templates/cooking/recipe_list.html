{% extends "base.html" %}

{% load custom_filters_cooking %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">–†–µ—Ü–µ–ø—Ç–∏</h2>


    {% if user.is_authenticated %}
<a href="{% url 'create_recipe' %}" class="btn btn-success mb-3">–î–æ–±–∞–≤–∏ —Ä–µ—Ü–µ–ø—Ç–∞</a>
        <a href="{% url 'favourite_recipes' %}" class="btn btn-primary mb-3">üìñ –ó–∞–ø–∞–∑–µ–Ω–∏ –º–µ–Ω—é—Ç–∞</a>
{% else %}
<a href="{% url 'login' %}" class="btn btn-primary mb-3">–í–ª–µ–∑ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏ –∑–∞ –ø–æ–≤–µ—á–µ –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
{% endif %}
<div class="btn-group mb-4" role="group" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏">
    <button type="button" class="btn btn-outline-secondary category-btn" data-category="all">–í—Å–∏—á–∫–∏({{ total_recipes }})</button>
    {% for category in categories %}
        <button type="button" class="btn btn-outline-secondary category-btn" data-category="{{ category.name }}">{{ category.name }}({{ category.recipe_count }})</button>
    {% endfor %}
</div>

<div class="flex-grow-1">
    <label for="recipe-search" class="form-label">üîç –¢—ä—Ä—Å–∏ —Ä–µ—Ü–µ–ø—Ç–∞:</label>
    <input type="text" id="recipe-search" class="form-control" placeholder="–ò–º–µ..." onkeyup="filterRecipeByName()">
  </div>

<form method="get" action="{% url 'recipe_list' %}" class="mb-4">
  <label for="ingredient-select" class="form-label">üßÇ –†–µ—Ü–µ–ø—Ç–∞ —Å –ø—Ä–æ–¥—É–∫—Ç:</label>
  <select id="ingredient-select" name="ingredient" class="form-select" onchange="this.form.submit()">
    <option value="all" {% if request.GET.ingredient == "all" %}selected{% endif %}>-- –í—Å–∏—á–∫–∏ --</option>
    {% for product in products %}
      <option value="{{ product.id }}"
          {% if request.GET.ingredient == product.id|stringformat:"s" %}selected{% endif %}>
    {{ product.id|get_product_name }}
      </option>
    {% endfor %}
  </select>
  <input type="hidden" name="category" value="{{ selected_category }}">
</form>



<div class="products-scroll-wrapper" style="max-height: 70vh; overflow-y: auto;">

{% if recipes %}

    {% for recipe in recipes %}
        <div class="card h-100 border-light shadow-sm recipe-card"
                data-category="{{ recipe.category.name|lower }}"
                data-name="{{ recipe.name|lower }}"
                {% if recipe.is_top %}class="top-recipe"{% endif %}>
  <div class="row g-0 align-items-center">
    <div class="col-md-4 d-flex align-items-center" style="height: 180px;">
  {% if recipe.image %}
    <img src="{{ recipe.image.url }}" class="img-fluid mh-100 w-100 object-fit-cover rounded-start" alt="{{ recipe.name }}">
  {% else %}
    <img src="/media/recipe_images/no_image.png" class="img-fluid mh-100 w-100 object-fit-cover rounded-start" alt="Default Image">
  {% endif %}
</div>

    <div class="col-md-5">
      <div class="card-body">
        <h5 class="card-title"><a href="{% url 'recipe_view' recipe.id %}">{{ recipe.name }}</a></h5>
        <p class="card-text mb-1"><strong>‚è±Ô∏è:</strong> {{ recipe.time_to_prepare }} –º–∏–Ω</p>
        <p class="card-text mb-1"><strong>üí∞:</strong> {% if user.is_authenticated %}{{ recipe.user_cost }} –ª–≤.{% else %}N/A{% endif %}</p>
        <p class="card-text mb-1"><strong>üî•:</strong> {{ recipe.total_calories }} kcal</p>
        <p class="card-text mb-1"><strong>üìÇ:</strong> {{ recipe.category.name }}</p>

        {% if recipe.user_availability_status == "OK" %}
          <p class="text-success small">‚úÖ –í—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –Ω–∞–ª–∏—á–Ω–∏</p>
        {% else %}
          <p class="text-danger small">‚ùå –õ–∏–ø—Å–≤–∞—â–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</p>
        {% endif %}

        {% if recipe.times_cooked %}
          <p class="text-muted small mt-2">üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–≤—è–Ω–∞ <strong>{{ recipe.times_cooked }}</strong> –ø—ä—Ç–∏</p>
        {% endif %}
      </div>
    </div>

    <div class="col-md-3 text-center px-3">

    {% if user.is_authenticated %}
  <button type="button" class="btn btn-info btn-sm w-100 mt-2"
          data-bs-toggle="modal"
          data-bs-target="#addToGroupModal"
          data-recipe-id="{{ recipe.id }}"
          data-recipe-name="{{ recipe.name }}">
    ‚≠ê –î–æ–±–∞–≤–∏ –≤ –≥—Ä—É–ø–∞
  </button>
{% endif %}

      {% if not recipe.user_availability %}
        <form action="{% url 'generate_recipe_shopping_list' recipe.id %}" method="POST" class="mb-2">
          {% csrf_token %}
          <button type="submit" class="btn btn-warning btn-sm w-100">üõí –°–ø–∏—Å—ä–∫</button>
        </form>
      {% endif %}

      {% if user.is_authenticated %}
        <form action="{% url 'cook_recipe' recipe.id %}" method="POST">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-sm w-100">üç≥ –ü—Ä–∏–≥–æ—Ç–≤–∏</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

    {% endfor %}
    </div>
    {% if product %}
        <div class="d-flex align-items-center justify-content-center text-center py-3">
    <span>–ü–æ—Ç—ä—Ä—Å–∏ –≤&nbsp;</span>

    <a href="https://www.google.com/search?q=—Ä–µ—Ü–µ–ø—Ç–∏+—Å+{{ product.name|urlencode }}" target="_blank" class="ms-1">Google</a>
    <span>&nbsp;–∑–∞ –æ—â–µ –∏–¥–µ–∏ –∑–∞ —Ä–µ—Ü–µ–ø—Ç–∏ —Å {{ product.name }}</span>
  </div>
        {% else %}

    <div class="d-flex align-items-center justify-content-center text-center py-3">
    <span>–ü–æ—Ç—ä—Ä—Å–∏ –≤&nbsp;</span>

    <a href="https://www.google.com/search?q=—Ä–µ—Ü–µ–ø—Ç–∏+—Å+{{ product.name|urlencode }}" target="_blank" class="ms-1">Google</a>
    <span>&nbsp;–∑–∞ –æ—â–µ –∏–¥–µ–∏</span>
  </div>
        {% endif %}

{% else %}
  <div class="d-flex align-items-center justify-content-center text-center py-3">
    <span>–ù—è–º–∞ —Ä–µ—Ü–µ–ø—Ç–∏ —Å —Ç–æ–∑–∏ –ø—Ä–æ–¥—É–∫—Ç! –ü–æ—Ç—ä—Ä—Å–∏ –≤&nbsp;</span>

    <a href="https://www.google.com/search?q=—Ä–µ—Ü–µ–ø—Ç–∏+—Å+{{ product.name|urlencode }}" target="_blank" class="ms-1">Google</a>
  <span>&nbsp;–∑–∞ –∏–¥–µ–∏</span>
  </div>
{% endif %}


</div>

    <!-- Modal -->
<div class="modal fade" id="addToGroupModal" tabindex="-1" aria-labelledby="addToGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addToGroupForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addToGroupModalLabel">–î–æ–±–∞–≤–∏ —Ä–µ—Ü–µ–ø—Ç–∞ –≤ –ª—é–±–∏–º–∞ –≥—Ä—É–ø–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞—Ç–≤–æ—Ä–∏"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="recipeIdInput" name="recipe_id">
          <p id="recipeNameDisplay"></p>
          <div class="mb-3">
            <label for="groupSelect" class="form-label">–ò–∑–±–µ—Ä–∏ –≥—Ä—É–ø–∞</label>
            <select id="groupSelect" name="group_id" class="form-select" required>
              {% for group in user.favourite_groups.all %}
                <option value="{{ group.id }}">{{ group.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div id="addGroupError" class="text-danger small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–∫–∞–∑</button>
          <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏</button>
        </div>
      </form>
    </div>
  </div>
</div>



    <script>
  let selectedCategory = "all";

  function filterRecipes() {
    const searchInput = document.getElementById("recipe-search").value.toLowerCase();
    const cards = document.querySelectorAll(".recipe-card");

    cards.forEach(card => {
      const cardCategory = card.dataset.category || "";
      const cardName = card.dataset.name || "";
      const isTop = card.classList.contains("top-recipe");

      const categoryMatch = selectedCategory === "all" || cardCategory === selectedCategory;
      const nameMatch = cardName.includes(searchInput);

      const showCard = searchInput ? nameMatch : categoryMatch;
      card.style.display = showCard ? "block" : "none";
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("recipe-search").addEventListener("input", filterRecipes);

    document.querySelectorAll(".category-btn").forEach(button => {
      button.addEventListener("click", () => {
        document.querySelectorAll(".category-btn").forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        selectedCategory = button.dataset.category.toLowerCase();
        filterRecipes();
      });
    });

    filterRecipes();
  });
</script>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const addToGroupModal = document.getElementById("addToGroupModal");
  addToGroupModal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const recipeId = button.getAttribute("data-recipe-id");
    const recipeName = button.getAttribute("data-recipe-name");

    document.getElementById("recipeIdInput").value = recipeId;
    document.getElementById("recipeNameDisplay").textContent = "–†–µ—Ü–µ–ø—Ç–∞: " + recipeName;
  });

  document.getElementById("addToGroupForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const recipeId = document.getElementById("recipeIdInput").value;
    const groupId = document.getElementById("groupSelect").value;

    fetch("{% url 'add_recipe_to_group_ajax' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "recipe_id=" + recipeId + "&group_id=" + groupId
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const modal = bootstrap.Modal.getInstance(addToGroupModal);
        modal.hide();
        alert("‚úÖ " + data.recipe_name + " –µ –¥–æ–±–∞–≤–µ–Ω–∞ –≤ –≥—Ä—É–ø–∞ '" + data.group_name + "'");
      } else {
        document.getElementById("addGroupError").textContent = data.error;
      }
    });
  });
});
</script>



{% endblock %}

