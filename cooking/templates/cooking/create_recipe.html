{% extends "base.html" %}

{% block content %}
<div class="container my-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="card-title mb-4">üë®‚Äçüç≥ –°—ä–∑–¥–∞–π –Ω–æ–≤–∞ —Ä–µ—Ü–µ–ø—Ç–∞</h2>

      <form method="post" action="{% url 'save_recipe' %}">
        {% csrf_token %}

        <h4 class="mb-3">üìã –î–µ—Ç–∞–π–ª–∏</h4>

        <div class="mb-3">
          <label for="name" class="form-label">–ò–º–µ:</label>
          <input type="text" name="name" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="category_id" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
          <select name="category_id" class="form-select" required>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="time_to_prepare" class="form-label">‚è±Ô∏è –í—Ä–µ–º–µ (–º–∏–Ω):</label>
          <input type="number" name="time_to_prepare" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="instructions" class="form-label">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</label>
          <textarea name="instructions" class="form-control" rows="5"></textarea>
        </div>

        <div class="mb-3">
          <label for="url_link" class="form-label">üîó URL (–ø–æ –∂–µ–ª–∞–Ω–∏–µ):</label>
          <input type="url" name="url_link" class="form-control">
        </div>

        <h4 class="mt-4 mb-3">üß™ –°—ä—Å—Ç–∞–≤–∫–∏</h4>
        <div class="table-responsive">
          <table class="table table-bordered align-middle" id="ingredientTable">
            <thead class="table-light">
              <tr>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                <th>–ú—è—Ä–∫–∞</th>
                <th>–ü—Ä–µ–º–∞—Ö–Ω–∏</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <select name="product_id[]" class="form-select" onchange="checkNewProduct(this)">
                    <option value="" disabled selected>–ò–∑–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç</option>
                    <option value="new">‚ûï –î–æ–±–∞–≤–∏ –Ω–æ–≤ –ø—Ä–æ–¥—É–∫—Ç</option>
                    {% for product in products %}
                      <option value="{{ product.id }}">{{ product.name }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td><input type="number" name="quantity[]" class="form-control" step="0.001" required></td>
                <td><input type="text" name="unit[]" class="form-control" placeholder="–ø–æ –∂–µ–ª–∞–Ω–∏–µ"></td>
                <td><button type="button" class="removeRow btn btn-sm btn-danger">‚úñ</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="button" id="addRow" class="btn btn-outline-primary">‚ûï –î–æ–±–∞–≤–∏ —Å—ä—Å—Ç–∞–≤–∫–∞</button>
          <button type="submit" class="btn btn-success">üíæ –ó–∞–ø–∞–∑–∏ —Ä–µ—Ü–µ–ø—Ç–∞</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for new product -->
<div class="modal fade" id="product-modal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="new-product-form">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="productModalLabel">‚ûï –î–æ–±–∞–≤–∏ –Ω–æ–≤ –ø—Ä–æ–¥—É–∫—Ç</h5>
          <button type="button" class="btn-close" onclick="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <select name="category_id" class="form-select">
              {% for category in product_categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="new-product-name" class="form-label">–ò–º–µ:</label>
            <input type="text" name="new_product_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="new-calories" class="form-label">–ö–∞–ª–æ—Ä–∏–∏:</label>
            <input type="number" step="1" name="new_calories" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">–ó–∞—Ç–≤–æ—Ä–∏</button>
          <button type="button" class="btn btn-primary" onclick="saveNewProduct()">–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–¥—É–∫—Ç–∞</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Add new ingredient row
document.getElementById("addRow").addEventListener("click", function () {
  const tableBody = document.querySelector("#ingredientTable tbody");
  const newRow = tableBody.rows[0].cloneNode(true);
  newRow.querySelectorAll("input, select").forEach(el => el.value = "");
  newRow.querySelector(".removeRow").addEventListener("click", function () {
    this.closest("tr").remove();
  });
  tableBody.appendChild(newRow);
});

// Remove row handler
document.querySelectorAll(".removeRow").forEach(button => {
  button.addEventListener("click", function () {
    this.closest("tr").remove();
  });
});

// Modal logic
function checkNewProduct(selectElement) {
  if (selectElement.value === "new") {
    new bootstrap.Modal(document.getElementById("product-modal")).show();
  }
}

function closeModal() {
  const modalEl = document.getElementById("product-modal");
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
}

async function saveNewProduct() {
  const formData = new FormData(document.getElementById("new-product-form"));
  const response = await fetch("{% url 'add_product' %}", {
    method: "POST",
    body: formData,
    headers: {
      "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      "Accept": "application/json"
    }
  });

  if (response.ok) {
    const newProduct = await response.json();
    document.querySelectorAll("select[name='product_id[]']").forEach(dropdown => {
      const option = document.createElement("option");
      option.value = newProduct.id;
      option.textContent = newProduct.name;
      option.selected = true;
      dropdown.appendChild(option);
    });
    closeModal();
  } else {
    alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞.");
  }
}
</script>
{% endblock %}
