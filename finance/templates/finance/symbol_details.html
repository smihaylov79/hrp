{% extends "finance/navigation.html" %}
{% load custom_filters_finance %}
{% block finance_navigation %}

<div class="container mt-5">
    <div class="card shadow-sm p-4">
    <form method="GET" onsubmit="encodeHash(this)">
  <input type="text" id="symbolInput" name="symbol" placeholder="–í—ä–≤–µ–¥–∏ —Å–∏–º–≤–æ–ª" value="{{ symbol }}" />
  <button type="submit">–ü—Ä–æ–≤–µ—Ä–∏</button>
</form>
    <a href="{% url 'check_margin' symbol=symbol %}" class="btn btn-primary mx-2">
    Check margin requirements
  </a>

<a href="{% url 'prediction_page' %}?symbol={{ symbol|urlencode }}&timeframe={{ selected_timeframe|default:'D1' }}" class="btn btn-outline-success mx-2">
  üîÆ Predict Price
</a>


<div id="predictedPriceResult" class="mt-3 text-success fw-bold"></div>

        <!-- Header Section with Name and Bid/Ask -->
<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap">
  <div>
    <h2 class="mb-1">{{ fundamentals.name }}</h2>
    <p class="mb-4 small">{{ fundamentals.symbol_mapping.sector }} / {{ fundamentals.symbol_mapping.industry }}</p>
  </div>


<div class="mb-4">
  {% if portfolios_with_symbol %}
    <div class="alert alert-info">
      ‚úÖ This symbol is already included in:
      <ul class="mb-0">
        {% for entry in portfolios_with_symbol %}
          <li><strong>{{ entry.portfolio.name }}</strong> ({{ entry.shares }} shares @ {{ entry.price_bought }})</li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <form method="POST" action="{% url 'add_symbol_to_portfolio' %}">
      {% csrf_token %}
      <input type="hidden" name="symbol_id" value="{{ fundamentals.symbol_mapping.id }}">
      <div class="d-flex gap-2 align-items-center">
        <select name="portfolio_id" class="form-select w-auto" required>
          <option value="" disabled selected>Select portfolio</option>
          {% for p in all_portfolios %}
            <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
        <input type="number" name="shares" class="form-control w-auto" placeholder="Shares" step="any" required>
        <input type="number" name="price_bought" class="form-control w-auto" placeholder="Price" step="any" required>
        <button type="submit" class="btn btn-success">‚ûï Add to Portfolio</button>
      </div>
    </form>
  {% endif %}
</div>




  {% if data and not data.error %}
    <div class="flex-grow-0" style="width: 20%;">
      <div class="alert alert-info p-2 small">
        <strong>{{ symbol }} ({{ data.currency_base }})</strong><br>
        üü¢ Bid: {{ data.bid }}<br>
        üîµ Ask: {{ data.ask }}<br>
      </div>
    </div>
  {% elif data and data.error %}
    <div class="alert alert-danger">‚ö†Ô∏è {{ data.error }}</div>
  {% endif %}
</div>

<!-- Fundamentals Cards Row -->
<div class="d-flex justify-content-between gap-3 mb-3 flex-wrap">
  <!-- Card 1 -->
  <div class="flex-grow-0" style="width: 32%;">
    <div class="alert alert-success p-3">
      <!-- Card 1 content -->

      <div class="d-flex justify-content-between"><span>EV/EBITDA:</span><b>{{ fundamentals.enterprise_to_ebitda|floatformat:2 }}</b></div>
      <div class="d-flex justify-content-between"><span>P/E:</span><b>{{ fundamentals.price_eps_current_year|floatformat:2 }}</b></div>
      <div class="d-flex justify-content-between"><span>EPS Trailing:</span><b>{{ fundamentals.eps_ttm }}</b></div>
      <div class="d-flex justify-content-between"><span>EPS Forward:</span><b>{{ fundamentals.eps_forward|floatformat:2 }}</b></div>
      <div class="d-flex justify-content-between"><span>PE Forward:</span><b>{{ fundamentals.forward_pe|floatformat:2 }}</b></div>
        <div class="d-flex justify-content-between"><span>Revenue/Share:</span><b>{{ fundamentals.revenue_per_share|floatformat:2 }}</b></div>
        <div class="d-flex justify-content-between"><span>Gross Profit:</span><b>{{ fundamentals.gross_profits|billions }} B</b></div>
        <div class="d-flex justify-content-between"><span>Op. Cashflow:</span><b>{{ fundamentals.operating_cashflow|billions }} B</b></div>
        <div class="d-flex justify-content-between"><span>PEG:</span><b>{{ fundamentals.trailing_peg_ratio|floatformat:2 }}</b></div>
      <div class="d-flex justify-content-between"><span>Shares Outstanding:</span><b>{{ fundamentals.shares_outstanding|billions }} B</b></div>
    </div>
  </div>

  <!-- Card 2 -->
  <div class="flex-grow-0" style="width: 32%;">
    <div class="alert alert-warning p-3">
      <!-- Card 2 content -->
      <div class="d-flex justify-content-between"><span>Market Cap:</span><b>{{ fundamentals.market_cap|billions }} B</b></div>
      <div class="d-flex justify-content-between"><span>Enterprise Value:</span><b>{{ fundamentals.enterprise_value|billions }} B</b></div>
      <div class="d-flex justify-content-between"><span>Revenue:</span><b>{{ fundamentals.total_revenue|billions }} B</b></div>
      <div class="d-flex justify-content-between"><span>COGS:</span><b>{{ cogs|billions }} B</b></div>
      <div class="d-flex justify-content-between"><span>GM:</span><span><b>{{ gm_value|billions }} B</b><span> ({{ fundamentals.gross_margins|convert_percentage }} %)</span></span></div>
      <div class="d-flex justify-content-between"><span>EBITDA:</span><span><b>{{ fundamentals.ebitda|billions }} B</b><span> ({{ fundamentals.ebitda_margins|convert_percentage }} %)</span></span></div>
      <div class="d-flex justify-content-between"><span>EBIT:</span><span><b>{{ ebit|billions }} B</b><span> ({{ fundamentals.operating_margins|convert_percentage }} %)</span></span></div>
      <div class="d-flex justify-content-between"><span>Amortization:</span><b>{{ amortization|billions }} B</b></div>
      <div class="d-flex justify-content-between"><span>Debt:</span><b>{{ fundamentals.total_debt|billions }} B</b></div>
      <div class="d-flex justify-content-between"><span>Cash:</span><b>{{ fundamentals.total_cash|billions }} B</b></div>
    </div>
  </div>

  <!-- Card 3 -->
  <div class="flex-grow-0" style="width: 32%;">
    <div class="alert alert-secondary p-3">
      <!-- Add more metrics or visualizations here -->
        <div class="d-flex justify-content-between"><span>Price Target:</span><b>{{ fundamentals.target_median_price|floatformat:2 }} ({{ fundamentals_previous.target_median_price|floatformat:2 }})</b></div>
      <div class="d-flex justify-content-between"><span>Fair Price:</span><b>{{ fair_price|floatformat:2 }} ({{ fair_price_prev|floatformat:2 }})</b></div>
        <div class="d-flex justify-content-between"><span>Rating:</span><b>{{ fundamentals.average_analyst_rating }}</b></div>
      <div class="d-flex justify-content-between"><span>52 week range:</span><b>{{ fundamentals.fifty_two_week_low }} - {{ fundamentals.fifty_two_week_high }}</b></div>
        <div class="d-flex justify-content-between"><span>52 week change:</span><b>{{ fundamentals.fifty_two_week_change|convert_percentage }} %</b></div>
        <div class="d-flex justify-content-between"><span>Beta:</span><b>{{ fundamentals.beta }}</b></div>
      <div class="d-flex justify-content-between"><span>50 day average:</span><b>{{ fundamentals.fifty_day_average|floatformat:2 }}</b></div>
      <div class="d-flex justify-content-between"><span>200 day average:</span><b>{{ fundamentals.two_hundred_day_average|floatformat:2 }}</b></div>
        <div class="d-flex justify-content-between"><span>RSI(14):</span><b>{{ rsi|floatformat:2 }}</b></div>
      <div class="d-flex justify-content-between"><span>Divident Date:</span><b>{{ fundamentals.ex_dividend_date }}</b></div>
      <!-- Add more if needed -->
    </div>
  </div>
</div>

    </div>



<form method="GET" style="display: flex; gap: 1rem; align-items: center;">
  <input type="hidden" name="symbol" value="{{ symbol }}">

  <!-- Timeframe selector -->
  <select name="timeframe" onchange="this.form.submit()">
    <option value="D1" {% if selected_timeframe == 'D1' %}selected{% endif %}>1 Day</option>
    <option value="M1" {% if selected_timeframe == 'M1' %}selected{% endif %}>1 Min</option>
    <option value="M5" {% if selected_timeframe == 'M5' %}selected{% endif %}>5 Min</option>
    <option value="M15" {% if selected_timeframe == 'M15' %}selected{% endif %}>15 Min</option>
    <option value="M30" {% if selected_timeframe == 'M30' %}selected{% endif %}>30 Min</option>
    <option value="H1" {% if selected_timeframe == 'H1' %}selected{% endif %}>1 Hour</option>
    <option value="H4" {% if selected_timeframe == 'H4' %}selected{% endif %}>4 Hour</option>
    <option value="W1" {% if selected_timeframe == 'W1' %}selected{% endif %}>1 Week</option>
    <option value="MN1" {% if selected_timeframe == 'MN1' %}selected{% endif %}>1 Month</option>
  </select>

  <!-- Chart type toggle -->
  <div id="chartTypeToggle">
    <label>
      <input type="radio" name="chartType" value="candlestick" checked>
      üìä
    </label>
    <label>
      <input type="radio" name="chartType" value="line">
      üìà
    </label>
  </div>
</form>



  <script src="https://code.highcharts.com/stock/highstock.js"></script>

{% if data %}
    {% if data.error %}
        <div class="alert alert-danger">‚ö†Ô∏è {{ data.error }}</div>
        {% else %}
  <div id="container" style="height: 600px; min-width: 600px"></div>
{% endif %}

{% endif %}

   <div class="card mb-4 shadow-sm">
  <div class="card-header bg-light">
    <h6 class="mb-0">üìò Business Summary for: <span><b>{{ fundamentals.name }}</b></span></h6>
  </div>
  <div class="card-body">
    <p class="text-muted" style="white-space: pre-line;">
      {{ fundamentals.symbol_mapping.long_business_summary }}
    </p>
  </div>
</div>

<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light">
  <h6 class="mb-0">üìò News related with: <span><b>{{ fundamentals.name }}</b></span></h6>
  </div>
{% if news %}
    <div class="row row-cols-1 g-3">
      {% for article in news %}
        <div class="col">
          <div class="card h-100 border-light shadow-sm">
            <div class="row g-0">
              <div class="col-md-4">
                {% if article.image_url %}
                  <img src="{{ article.image_url }}" class="img-fluid rounded-start w-50" alt="–ù–æ–≤–∏–Ω–∞">
                {% endif %}
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <h5 class="card-title">{{ article.title }}</h5>
                  <p class="card-text">{{ article.description }}</p>
                  <p class="card-text">
                    <small class="text-muted">üïí {{ article.published_at }} | üì∫ {{ article.source }}</small>
                  </p>
                  <a href="{{ article.url }}" target="_blank" class="btn btn-outline-primary btn-sm">–ü—Ä–æ—á–µ—Ç–∏</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">–ù—è–º–∞ –Ω–æ–≤–∏–Ω–∏ –∑–∞ —Ç–æ–∑–∏ —Å–∏–º–≤–æ–ª.</div>
  {% endif %}
</div>

</div>

<script>
  const ohlcData = {{ ohlc_data|safe }};

  const lineData = ohlcData.map(d => [d[0], d[4]]);

  let chart;

  function renderChart(type) {
    if (chart) chart.destroy();

    chart = Highcharts.stockChart('container', {
      rangeSelector: { selected: 1 },
      title: { text: '{{ data.description }}' || '{{ fundamentals.name }} (from Yahoo)'  },
      series: [
        type === 'line'
          ? {
              type: 'line',
              name: '{{ symbol }}',
              data: lineData,
              tooltip: { valueDecimals: 2 },
            }
          : {
              type: 'candlestick',
              name: '{{ symbol }}',
              data: ohlcData,
              tooltip: { valueDecimals: 2 }
            }
      ],
    });
  }

  // Initial chart based on default selected button
  const defaultChartType = document.querySelector('input[name="chartType"]:checked').value;
  renderChart(defaultChartType);

  // Listener for button change
  document.querySelectorAll('input[name="chartType"]').forEach(btn => {
    btn.addEventListener('change', () => {
      renderChart(btn.value);
    });
  });
</script>

    <script>
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const symbol = urlParams.get('symbol');

    if (symbol) {
      fetch(`/finance/symbol-details/?symbol=${encodeURIComponent(symbol)}&ajax=true`)
        .then(response => response.text())
        .then(html => {
          document.getElementById('resultContainer').innerHTML = html;
        })
        .catch(err => {
          document.getElementById('resultContainer').textContent = '‚ö†Ô∏è Failed to load data.';
          console.error(err);
        });
    } else {
      document.getElementById('resultContainer').textContent = 'üîé No symbol provided.';
    }
  });
</script>


{% endblock %}