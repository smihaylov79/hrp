{% extends 'reports/reports_home.html' %}

{% block report_body %}

   <form method="get" class="border rounded p-4 mb-4 bg-light">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label for="id_main_category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select name="main_category" id="id_main_category" class="form-select">
                <option value="">-- –í—Å–∏—á–∫–∏ --</option>
                {% for category in form.fields.main_category.queryset %}
                    <option value="{{ category.id }}" {% if request.GET.main_category == category.id|stringformat:"s" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="id_date_from" class="form-label">–û—Ç</label>
            <input type="date" name="date_from" id="id_date_from" class="form-control" value="{{ request.GET.date_from }}">
        </div>
        <div class="col-md-3">
            <label for="id_date_to" class="form-label">–î–æ</label>
            <input type="date" name="date_to" id="id_date_to" class="form-control" value="{{ request.GET.date_to }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">–§–∏–ª—Ç—Ä–∏—Ä–∞–π</button>
        </div>
    </div>
</form>


     <script src="https://code.highcharts.com/highcharts.js"></script>

    <div class="d-flex flex-wrap gap-4 mb-4">
    <!-- Monthly Line Chart -->
{#    <div id="monthly_spent" style="width:60%; height: 400px;"></div>#}
    <div class="card p-3 shadow-sm" style="width:45%; height:300px">
        <h5 class="mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –∏–∑–±—Ä–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥</h5>
        <ul class="list-unstyled">
            <li><strong>–û–±—â–æ —Ä–∞–∑—Ö–æ–¥–∏:</strong> {{ total_spent }} –ª–≤.</li>
            <li><strong>–ë—Ä–æ–π –ø–æ–∫—É–ø–∫–∏:</strong> {{ shoppings_count }}</li>
            <li><strong>5 –Ω–∞–π-–∫—É–ø—É–≤–∞–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:</strong> {{ most_purchased_names }}</li>
            <li><strong>–ù–∞–π-–≥–æ–ª—è–º —Ä–∞–∑—Ö–æ–¥ –∑–∞:</strong> {{ biggest_spent.product__name }} ‚Äì {{ biggest_spent.spent }} –ª–≤.</li>
            <li><strong>–ù–∞–π-—Å–∫—ä–ø –ø—Ä–æ–¥—É–∫—Ç:</strong> {{ highest_price.product__name }} ‚Äì {{ highest_price.price }} –ª–≤.</li>
            <li><strong>–ù–∞–π-–µ–≤—Ç–∏–Ω –ø—Ä–æ–¥—É–∫—Ç:</strong> {{ lowest_price.product__name }} ‚Äì {{ lowest_price.price }} –ª–≤.</li>
            <li><strong>–ù–∞–π-–≥–æ–ª—è–º–æ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ:</strong> {{ top_increase.product }} ‚Äì {{ top_increase.change }} –ª–≤.</li>
            <li><strong>–ù–∞–π-–≥–æ–ª—è–º–æ –Ω–∞–º–∞–ª–µ–Ω–∏–µ:</strong> {{ top_decrease.product }} ‚Äì {{ top_decrease.change }} –ª–≤.</li>
        </ul>
    </div>

    <!-- Pie Chart -->
    <div style="width:45%;">
        {% if main_category_name == "" %}
            <div id="main-category-chart" style="height: 300px;"></div>
        {% else %}
            <div id="subcategory-chart" style="height: 300px;"></div>
        {% endif %}
    </div>
</div>

    <div id="monthly_spent" style="width:100%; height: 400px;"></div>

    <div id="weekly_spent" style="width:100%; height:400px;"></div>

    {% if main_category_name == "" %}

        <div id="main-category-chart"></div>
        {% else %}
        <div id="subcategory-chart"></div>

    {% endif %}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const mainChartContainer = document.getElementById('main-category-chart');
        if (mainChartContainer) {
            Highcharts.chart('main-category-chart', {
                chart: {type: 'pie'},
                title: {text: '–†–∞–∑—Ö–æ–¥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è'},
                series: [{
                    name: '–†–∞–∑—Ö–æ–¥',
                    data: {{ main_chart_data|safe }}
                }]
            });
        }
        Highcharts.chart('subcategory-chart', {
            chart: { type: 'pie' },
            title: {
                text: {% if main_category_name == "" %}
                                '–†–∞–∑—Ö–æ–¥ –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è'
                            {% else %}
                                '–†–∞–∑—Ö–æ–¥ –∑–∞ {{ main_category_name }} (–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)'
                            {% endif %}
            },
            series: [{
                name: '–†–∞–∑—Ö–æ–¥',
                data: {{ sub_chart_data|safe }}
            }]
        })
    }

    )
        </script>

    <script>
        const data = JSON.parse('{{ monthly_data|escapejs }}');

        Highcharts.chart('monthly_spent', {
            chart: {
                type: 'line'
            },
            title: {
                text:
                    {% if main_category_name == "" %}
                    '–†–∞–∑—Ö–æ–¥–∏ –ø–æ –º–µ—Å–µ—Ü'
                {% else %}
                                '–†–∞–∑—Ö–æ–¥ –∑–∞ {{ main_category_name }} –ø–æ –º–µ—Å–µ—Ü'
                            {% endif %}
            },
            xAxis: {
                categories: data.map(item => item.month),
                title: { text: '–ú–µ—Å–µ—Ü' }
            },
            yAxis: {
                min: 0,
                title: { text: '–ª–≤.' }
            },
            series: [{
                name: '–û–±—â–æ',
                data: data.map(item => item.total)
            }]
        });
    </script>
    <script>
        const weeklyData = JSON.parse('{{ weekly_data|escapejs }}');

        Highcharts.chart('weekly_spent', {
            chart: {
                type: 'line'
            },
            title: {
                text:
                    {% if main_category_name == "" %}
                    '–†–∞–∑—Ö–æ–¥–∏ –ø–æ —Å–µ–¥–º–∏—Ü–∞'
                {% else %}
                                '–†–∞–∑—Ö–æ–¥ –∑–∞ {{ main_category_name }} –ø–æ —Å–µ–¥–º–∏—Ü–∞'
                            {% endif %}

            },
            xAxis: {
                categories: weeklyData.map(item => item.week),
                title: { text: '—Å–µ–¥–º–∏—Ü–∞' }
            },
            yAxis: {
                min: 0,
                title: { text: '–ª–≤.' }
            },
            series: [{
                name: '–û–±—â–æ',
                data: weeklyData.map(item => item.total)
            }]
        });
    </script>

{% endblock %}